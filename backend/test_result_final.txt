
> letsroll-backend@1.0.0 test
> jest services/__tests__/characterService.test.ts

FAIL src/services/__tests__/characterService.test.ts
  characterService - Sistema Ordem Paranormal
    getCharacters
      Ã”ÃªÃœ deve buscar personagens com filtro por campaignId (4 ms)
      Ã”ÃªÃœ deve buscar personagens com filtro por userId (1 ms)
      Ã”ÃªÃœ deve buscar personagens com filtro de campanha e usuâ”œÃ­rio combinados (1 ms)
      Ã”ÃªÃœ deve buscar todos os personagens se sem filtros (1 ms)
      Ã”ÃªÃœ deve retornar do cache se disponâ”œÂ¡vel (1 ms)
      Ã”ÃªÃœ deve lanâ”œÂºar erro se busca falhar (29 ms)
    createCharacter
      Ã”ÃªÃœ deve criar personagem com valores padrâ”œÃºo (2 ms)
      Ã”ÃªÃœ deve validar soma de atributos na criaâ”œÂºâ”œÃºo (3 ms)
      Ã”ÃªÃœ deve validar mâ”œÃ­ximo de atributo na criaâ”œÂºâ”œÃºo (1 ms)
      Ã”ÃªÃœ deve validar apenas um atributo pode ser 0 (1 ms)
      Ã”ÃªÃœ deve aceitar atributos vâ”œÃ­lidos com um zero (1 ms)
      Ã”ÃªÃœ deve criar personagem com atributos customizados (1 ms)
      Ã”ÃªÃœ deve rejeitar perâ”œÂ¡cia COMPETENT com NEX < 35 (1 ms)
      Ã”ÃªÃœ deve lanâ”œÂºar erro se criaâ”œÂºâ”œÃºo falhar (1 ms)
      â”œÃ¹ deve rejeitar perâ”œÂ¡cia EXPERT com NEX < 70 (16 ms)
      Ã”ÃªÃœ deve aceitar perâ”œÂ¡cia COMPETENT com NEX >= 35 (1 ms)
      Ã”ÃªÃœ deve rejeitar perâ”œÂ¡cia EXPERT com NEX < 70 (1 ms)
      Ã”ÃªÃœ deve aceitar perâ”œÂ¡cia EXPERT com NEX >= 70
      Ã”ÃªÃœ nâ”œÃºo deve permitir que o mestre da campanha crie personagem (1 ms)
      Ã”ÃªÃœ deve criar personagem sem campanha (standalone) (1 ms)
      Ã”ÃªÃœ deve usar NEX padrâ”œÃºo (5) se nâ”œÃºo informado (1 ms)
      Ã”ÃªÃœ deve continuar criaâ”œÂºâ”œÃºo mesmo se falhar ao conceder habilidades (1 ms)
    getCharacterById
      Ã”ÃªÃœ deve buscar personagem por ID (2 ms)
      Ã”ÃªÃœ deve retornar do cache se disponâ”œÂ¡vel (1 ms)
      Ã”ÃªÃœ deve lanâ”œÂºar erro se personagem nâ”œÃºo encontrado
    updateCharacter
      Ã”ÃªÃœ deve atualizar campos bâ”œÃ­sicos do personagem (2 ms)
      Ã”ÃªÃœ deve usar serviâ”œÂºo especializado para atualizar atributos (1 ms)
      Ã”ÃªÃœ deve usar serviâ”œÂºo especializado para atualizar skills
      Ã”ÃªÃœ deve lanâ”œÂºar erro se personagem nâ”œÃºo encontrado (1 ms)
    deleteCharacter
      Ã”ÃªÃœ deve deletar personagem e invalidar cache
      Ã”ÃªÃœ deve lanâ”œÂºar erro se deleâ”œÂºâ”œÃºo falhar (1 ms)
    updateAttributes
      Ã”ÃªÃœ deve atualizar atributos e recalcular recursos
      Ã”ÃªÃœ deve lidar com troca de origem (remover/adicionar perâ”œÂ¡cias) (1 ms)
      Ã”ÃªÃœ deve falhar se erro ao buscar personagem para atualizaâ”œÂºâ”œÃºo (1 ms)
      Ã”ÃªÃœ deve atualizar stats e xp diretamente
    updateSkills
      Ã”ÃªÃœ deve atualizar perâ”œÂ¡cias e recalcular bâ”œâ”¤nus (1 ms)
    applyCondition
      Ã”ÃªÃœ deve aplicar condiâ”œÂºâ”œÃºo usando ordemParanormalService
      Ã”ÃªÃœ deve aplicar condiâ”œÂºâ”œÃºo com condiâ”œÂºâ”œÃes derivadas (1 ms)
    removeCondition
      Ã”ÃªÃœ deve remover condiâ”œÂºâ”œÃºo do personagem
    updateNEX
      Ã”ÃªÃœ deve atualizar NEX e recalcular recursos (3 ms)
      Ã”ÃªÃœ deve lanâ”œÂºar erro se NEX fora do range (4 ms)
    updatePV
      Ã”ÃªÃœ deve atualizar PV como valor absoluto
      Ã”ÃªÃœ deve atualizar PV como delta
      Ã”ÃªÃœ deve aplicar condiâ”œÂºâ”œÃºo Morrendo se PV <= 0
      Ã”ÃªÃœ deve remover Morrendo se PV > 0 (1 ms)
    updateSAN
      Ã”ÃªÃœ deve atualizar SAN e aplicar condiâ”œÂºâ”œÃes se necessâ”œÃ­rio
      Ã”ÃªÃœ deve aplicar Enlouquecendo se SAN = 0 (1 ms)
      Ã”ÃªÃœ deve aplicar Perturbado se SAN <= 25% (1 ms)
    updatePE
      Ã”ÃªÃœ deve atualizar PE como valor absoluto
      Ã”ÃªÃœ deve atualizar PE como delta
    rollSkillTest
      Ã”ÃªÃœ deve rolar teste de perâ”œÂ¡cia com penalidades
      Ã”ÃªÃœ deve lanâ”œÂºar erro se perâ”œÂ¡cia nâ”œÃºo encontrada (1 ms)
    rollAttack
      Ã”ÃªÃœ deve rolar ataque com penalidades
    applyDamage
      Ã”ÃªÃœ deve aplicar dano fâ”œÂ¡sico reduzindo PV (1 ms)
      Ã”ÃªÃœ deve aplicar dano mental reduzindo SAN
    recoverPE
      Ã”ÃªÃœ deve recuperar PE baseado no NEX (1 ms)

  Ã”Ã¹Ã… characterService - Sistema Ordem Paranormal Ã”Ã‡â•‘ createCharacter Ã”Ã‡â•‘ deve rejeitar perâ”œÂ¡cia EXPERT com NEX < 70

    expect(received).rejects.toThrow(expected)

    Expected pattern: /Nâ”œÂ¡vel de treinamento EXPERT nâ”œÃºo â”œÂ® permitido/
    Received message: "Erro ao criar personagem: supabase_1.supabase.from(...).select(...).eq is not a function"

          279 |       const err = error as AppError
          280 |       logger.error({ error }, 'Error creating character')
        > 281 |       throw new Error('Erro ao criar personagem: ' + (err.message || 'Erro desconhecido'))
              |             ^
          282 |     }
          283 |   },
          284 |

      at Object.createCharacter (src/services/characterService.ts:281:13)
      at Object.<anonymous> (src/services/__tests__/characterService.test.ts:393:26)
      at Object.toThrow (../node_modules/expect/build/index.js:2155:20)
      at Object.<anonymous> (src/services/__tests__/characterService.test.ts:403:17)

Test Suites: 1 failed, 1 total
Tests:       1 failed, 55 passed, 56 total
Snapshots:   0 total
Time:        2.42 s, estimated 3 s
Ran all test suites matching services/__tests__/characterService.test.ts.
[2025-12-11 12:32:58.766 -0300] [34mDEBUG[39m: [36mCache hit para personagens[39m
    [35mcacheKey[39m: "characters:campaign:camp-123"
[2025-12-11 12:32:58.767 -0300] [31mERROR[39m: [36mError fetching characters[39m
    error: {
      "message": "Database error"
    }
[2025-12-11 12:32:58.799 -0300] [31mERROR[39m: [36mError creating character[39m
    error: {}
[2025-12-11 12:32:58.802 -0300] [31mERROR[39m: [36mError creating character[39m
    error: {}
[2025-12-11 12:32:58.803 -0300] [31mERROR[39m: [36mError creating character[39m
    error: {}
[2025-12-11 12:32:58.807 -0300] [31mERROR[39m: [36mError creating character[39m
    error: {}
[2025-12-11 12:32:58.808 -0300] [31mERROR[39m: [36mError creating character[39m
    error: {}
[2025-12-11 12:32:58.809 -0300] [31mERROR[39m: [36mError creating character[39m
    error: {}
[2025-12-11 12:32:58.828 -0300] [31mERROR[39m: [36mError creating character[39m
    error: {}
[2025-12-11 12:32:58.830 -0300] [31mERROR[39m: [36mError creating character[39m
    error: {}
[2025-12-11 12:32:58.833 -0300] [31mERROR[39m: [36mError granting class abilities during character creation[39m
    [35mcharacterId[39m: "char-123"
    error: {}
[2025-12-11 12:32:58.835 -0300] [34mDEBUG[39m: [36mCache hit para personagem[39m
    [35mcacheKey[39m: "characters:char-123"
[2025-12-11 12:32:58.836 -0300] [31mERROR[39m: [36mError fetching character[39m
    error: {
      "message": "Not found",
      "code": "PGRST116"
    }
[2025-12-11 12:32:58.841 -0300] [31mERROR[39m: [36mError updating character[39m
    error: {
      "message": "Not found"
    }
[2025-12-11 12:32:58.843 -0300] [31mERROR[39m: [36mError deleting character[39m
    error: {
      "message": "Delete failed"
    }
[2025-12-11 12:32:58.845 -0300] [31mERROR[39m: [36mError updating character[39m
    error: {
      "message": "DB Error fetching"
    }
[2025-12-11 12:32:58.848 -0300] [31mERROR[39m: [36mError granting class abilities during NEX update[39m
    [35mcharacterId[39m: "char-123"
    error: {}
[2025-12-11 12:32:58.851 -0300] [31mERROR[39m: [36mError updating NEX[39m
    error: {}
[2025-12-11 12:32:58.854 -0300] [31mERROR[39m: [36mError updating NEX[39m
    error: {}
npm error Lifecycle script `test` failed with error:
npm error code 1
npm error path K:\LETS\ANT\lets-roll-cursor\backend
npm error workspace letsroll-backend@1.0.0
npm error location K:\LETS\ANT\lets-roll-cursor\backend
npm error command failed
npm error command C:\WINDOWS\system32\cmd.exe /d /s /c jest services/__tests__/characterService.test.ts
